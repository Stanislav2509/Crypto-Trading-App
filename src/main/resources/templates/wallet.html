<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <link th:href="@{/css/nav-style.css}" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/wallet-style.css}">
</head>
<body>
<div th:replace="~{fragments/navigation}"></div>
 

<main>
  <h2>Assets</h2>
  <table border="1">
  <thead>
  <tr>
    <th>Crypto Type</th>
    <th>Total Quantity</th>
    <th>Money in Currency</th>
    <th>Profit/Loss</th>
  </tr>
  </thead>
  <tbody id="assetTable">
  <tr th:each ="asset : ${assets}">
    <td th:text="${asset.cryptoType.symbol}"></td>
    <td th:text="${asset.totalQuantity.stripTrailingZeros().toPlainString()}"></td>
    <td th:text="${asset.moneyCurrency}"></td>
    <td th:id="${asset.cryptoType.symbol}"
        th:text="${#numbers.formatDecimal(asset.profitLoss, 1, 2, 'POINT')}"
        th:classappend="${asset.profitLoss > 0 ? 'profit' : (asset.profitLoss < 0 ? 'loss' : 'neutral')}">
    </td>
  </tr>
  </tbody>
</table>
</main>

<script>
  let socket = new SockJS('/ws');
  let stompClient = Stomp.over(socket);

  stompClient.connect({}, function(frame) {

      stompClient.subscribe('/topic/asset', function(message) {
          let prices = JSON.parse(message.body);

          let rows = document.querySelectorAll("#assetTable tr");
          rows.forEach(row => {
              const cryptoType = row.cells[0].innerText;
              row.cells[2].innerText = prices[cryptoType].moneyCurrency.toFixed(2);

              let profitLoss = prices[cryptoType].profitLoss;
              let profitLossCell = document.getElementById(`${cryptoType}`);
                profitLossCell.innerText = profitLoss.toFixed(2);

          profitLossCell.classList.remove("profit", "loss", "neutral");

            if (profitLoss < 0) {
                profitLossCell.style.color = "red";
            } else if (profitLoss > 0) {
                profitLossCell.style.color = "green";
            }
          });
      });
  });
</script>

</body>
</html>